---
layout: post
title: MIT6.824学习笔记（四） -- Raft
categories: MIT6.824
tags: 分布式 Raft
---

* content
{:toc}

MIT6.824（2020）学习笔记，Lecture 6和7 - Raft。



## 1. 背景

前面学习了 MapReduce（[MIT6.824学习笔记（一） -- 课程介绍 及 MapReduce](https://xiaodongq.github.io/2024/08/17/mit-6-824-1-overview-mapreduce/)） 和 GFS（[MIT6.824学习笔记（三） -- GFS](https://xiaodongq.github.io/2024/08/21/mit-6-824-3-gfs/)），关于Go语言RPC和线程的`Lecture 2`暂时先挂起了。

`Lecture 4`关于主备副本，暂时只看了讲义：[6.824 2020 Lecture 4: Primary/Backup Replication](http://nil.csail.mit.edu/6.824/2020/notes/l-vm-ft.txt)，了解了虚拟机主备容错的基本过程，可以先过渡到Raft。

`Lecture 5`讲Go语言的协程，内存模型和并发控制等特性，也暂时跳过，实验时练习。

Raft部分分了上下两堂课，Lecture 6 - Raft (1) 和 Lecture 7 - Raft (2) 。

相关资料：

* 讲义：
    * [6.824 2020 Lecture 6: Raft (1)](http://nil.csail.mit.edu/6.824/2020/notes/l-raft.txt)
    * [6.824 2020 Lecture 7: Raft (2)](http://nil.csail.mit.edu/6.824/2020/notes/l-raft2.txt)
* 课程视频：
    * [Lecture 6: Fault Tolerance - Raft(1)](https://www.bilibili.com/video/BV1R7411t71W?p=6&vd_source=477b80445c7c1a81617bbea3bdf9a3c1)
    * [Lecture 6: Fault Tolerance - Raft(2)](https://www.bilibili.com/video/BV1R7411t71W?p=7&vd_source=477b80445c7c1a81617bbea3bdf9a3c1)
* 课程中文翻译：
    * [Lecture 06 - Raft1](https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/lecture-06-raft1)
    * [lecture 07 - Raft2](https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/lecture-07-raft2)

*说明：本博客作为个人学习实践笔记，可供参考但非系统教程，可能存在错误或遗漏，欢迎指正。若需系统学习，建议参考原链接。*

## 2. Raft论文

论文相关链接：

* [Raft论文](https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)
* [Raft论文翻译](https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md)
* 别人的学习笔记：[Raft 算法介绍](https://tanxinyu.work/raft/)

涉及Paxos算法，可了解相关论文：

* [《Paxos Made Simple》论文翻译](https://blog.mrcroxx.com/posts/paper-reading/paxos-made-simple/)
* [《Paxos Made Live - An Engineering Perspective》论文翻译](https://blog.mrcroxx.com/posts/paper-reading/paxos-made-live/)

### 2.1. 基本介绍

#### 2.1.1. Raft介绍

Raft算法出自斯坦福大学的博士生 Diego Ongaro 于`2014`年发表的论文：[In Search of an Understandable Consensus Algorithm(Extended Version)](https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)。

Raft这一名字来源于"Reliable, Replicated, Redundant, And Fault-Tolerant"（“可靠、可复制、可冗余、可容错”）的首字母缩写。

`Raft`是一种为了**管理复制日志**的`一致性算法(consensus algorithm)`。它提供了和 `Paxos`/`Multi-Paxos` 算法相同的功能和性能，但是它 **`更易理解`** 且 **`更容易构建实际的系统`**。

在设计 `Raft` 算法的时候，使用了一些特别的技巧来提升它的可理解性，包括`算法分解`（Raft 主要被分成了`领导人选举`，`日志复制`和`安全`三个模块）和`减少状态机的状态`（相对于 Paxos，Raft 减少了非确定性和服务器互相处于非一致性的方式）。

Raft算法在许多方面和现有的一致性算法都很相似，但也有些独特的特性：

* 强领导人，Raft使用一种更强的领导能力形式。如日志条目只从领导人发送给其他的服务器，简化了复制日志管理并且使Raft算法更加易于理解。
* 领导人选举，Raft算法在心跳机制上增加了一个`随机计时器`来选举领导人，在`解决冲突`的时候会更加简单快捷。
* 成员关系变更，Raft使用一种共同协商一致的方法来处理集群成员变换的问题，当变更发生时集群仍能正常继续工作。

集群内的节点都对选举出的领袖采取`信任`，因此**Raft不是一种`拜占庭容错`算法**。

#### 2.1.2. 拜占庭将军问题介绍

这里介绍下`拜占庭容错（Byzantine Fault Tolerance，BFT）`对应的`拜占庭将军问题（Byzantine Generals Problem）`。该问题是由[莱斯利·兰波特](https://zh.wikipedia.org/wiki/%E8%8E%B1%E6%96%AF%E5%88%A9%C2%B7%E5%85%B0%E6%B3%A2%E7%89%B9)在其同名论文（可见其1982年的[论文](http://lamport.azurewebsites.net/pubs/byz.pdf)）中提出的分布式对等网络通信容错问题。拜占庭将军问题被认为是容错性问题中最难的问题类型之一。

介绍下作者：

> 莱斯利·兰波特（英语：Leslie Lamport，1941年2月7日—），美国计算机科学家。也是排版系统`LaTeX`的开发者。Lamport在计算机科学领域，特别是分布式系统，领域有着深远的影响，也奠定的此领域的基础。他最著名的贡献是在分布式系统中的逻辑时钟和事件排序，Bakery算法和互斥解决方案，并发程序的规范和验证，不可靠网络中的Paxos协议，以及复制状态机（Replicated State Machines）的概念。他的成果为他赢得了许多奖项和荣誉，包括2013年的图灵奖、Dijkstra奖、IEEE约翰·冯·诺依曼奖和the Jean-Claude Laprie Award in Dependable Computing。他还于2011年当选为美国国家科学院院士。

番外：今天一个技术群里还在讨论`LaTeX`来着，有点巧。

下面信息参考：[维基百科：拜占庭将军问题](https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)

**问题描述：**

* 一组拜占庭将军分别各率领一支军队共同围困一座城市。为了简化问题，将各支军队的行动策略限定为`进攻`或`撤离`两种。因为部分军队进攻部分军队撤离可能会造成灾难性后果，因此各位将军必须通过`投票`来**达成一致策略**，即所有军队`一起进攻`或所有军队`一起撤离`。
* 因为各位将军分处城市不同方向，他们只能通过信使互相联系。在投票过程中每位将军都将自己投票给进攻还是撤退的信息通过信使**分别通知其他所有将军**，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以知道共同的投票结果而决定行动策略。

系统的问题在于，**可能将军中出现叛徒**，他们不仅可能向较为糟糕的策略投票，还可能选择性地发送投票信息。示例：

* 假设有9位将军投票，其中有1名叛徒。8名忠诚的将军中4人投进攻，4人投撤离。
* 这时候叛徒可能故意给4名投进攻的将领送信表示投票进攻，而给4名投撤离的将领送信表示投撤离。
* 这样一来在4名投进攻的将领看来，投票结果是`5人投进攻`，从而发起进攻；而在4名投撤离的将军看来则是`5人投撤离`。这样各支军队的一致协同就遭到了破坏。

由于将军之间需要通过信使通讯，叛变将军可能通过伪造信件来以其他将军的身份发送假投票。而即使在保证所有将军忠诚的情况下，也不能排除信使被敌人截杀，甚至被敌人间谍替换等情况。因此**很难通过保证人员可靠性及通讯可靠性来解决问题。**

假使那些忠诚（或是没有出错）的将军仍然能通过多数决定来决定他们的战略，便称达到了`拜占庭容错`。上述的故事映射到计算机系统里，将军便成了计算机，而信差就是通信系统。

`拜占庭容错`算法（Byzantine Fault Tolerance，BFT）的发展历程可见参考链接。

之前在 [区块链学习笔记](https://xiaodongq.github.io/2019/10/27/blockchain-note/) 中，了解过拜占庭将军问题，但只是限于很表面，此时结合工作经验和分布式角度看，清晰很多。对于比特币，使用的是工作量证明（POW）应对此类问题。

### 2.2. 复制状态机（Replicated state machines）

`复制状态机`在分布式系统中被用于解决很多容错的问题，典型应用就是一个独立的复制状态机去**管理**`领导选举`和`存储配置信息`并且在`领导人宕机`的情况下也要存活下来。

`一致性算法`就是从`复制状态机`的背景下提出的。在这种方法中，一组服务器上的状态机产生相同状态的副本，并且在一些机器宕掉的情况下也可以继续运行。

复制状态机通常都是基于 **`复制日志`** 实现的，如下所示的复制状态机架构图：

![复制状态机的架构](/images/replicated-state-machine-architecture.png)  
> 一致性算法管理着来自客户端指令的复制日志。状态机从日志中处理相同顺序的相同指令，所以产生的结果也是相同的。

* 每一个服务器存储一个包含一系列指令的日志，并且按照`日志的顺序`进行执行。
    * 每一个日志都按照`相同的顺序`包含`相同的指令`，所以每一个服务器都执行相同的指令序列。
    * 因为每个状态机都是确定的，每一次执行操作都产生相同的状态和同样的序列。
* 一致性算法的任务是 **保证复制日志的一致性**。
    * 服务器上的`一致性模块`接收客户端发送的指令然后添加到自己的日志中。它和其他服务器上的一致性模块进行`通信`来保证每一个服务器上的日志最终都以相同的顺序包含相同的请求，即使有些服务器发生故障。
    * 一旦指令被正确的复制，每一个服务器的状态机按照日志顺序处理他们，然后输出结果被返回给客户端。因此，服务器集群看起来形成了一个高可靠的状态机。

实际使用中的一致性算法通常包含以下特性：

* 安全保证性（绝对不会返回一个错误的结果）：在`非拜占庭错误`情况下，包括网络`延迟`、`分区`、`丢包`、`重复`和`乱序`等错误都可以保证正确。
* 可用性：只要大多数（`>n/2`）机器可运行，并能相互通信、并能和客户端通信，就可以保证可用。
* 不依赖时间来保证一致性：`错误的时钟`或者`极端的消息延迟`在最坏情况下可能会导致可用性问题
* 通常情况下，一条指令可以尽可能快的在集群中`大多数节点`响应一轮`远程过程调用（RPC）`时完成。小部分比较慢的节点不会影响系统整体的性能。

## 3. 小结


## 4. 参考

1、课表，其中有讲义：[6.824 Schedule: Spring 2020](http://nil.csail.mit.edu/6.824/2020/schedule.html)

* [6.824 2020 Lecture 6: Raft (1)](http://nil.csail.mit.edu/6.824/2020/notes/l-raft.txt)
* [6.824 2020 Lecture 7: Raft (2)](http://nil.csail.mit.edu/6.824/2020/notes/l-raft2.txt)

2、[维基百科：Raft](https://zh.wikipedia.org/zh-cn/raft)

3、论文：[Raft论文](https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)

4、[Raft论文翻译](https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md)

5、别人的论文学习笔记：[Raft 算法介绍](https://tanxinyu.work/raft/)

6、B站视频：[Lecture 6: Fault Tolerance - Raft(1)](https://www.bilibili.com/video/BV1R7411t71W?p=6&vd_source=477b80445c7c1a81617bbea3bdf9a3c1)

7、课程中文翻译：[Lecture 06 - Raft1](https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/lecture-06-raft1)

8、[lecture 07 - Raft2](https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/lecture-07-raft2)

9、[《Paxos Made Simple》论文翻译](https://blog.mrcroxx.com/posts/paper-reading/paxos-made-simple/)

10、[《Paxos Made Live - An Engineering Perspective》论文翻译](https://blog.mrcroxx.com/posts/paper-reading/paxos-made-live/)

11、[维基百科：拜占庭将军问题](https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)
